<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Street Image Compare View Side-by-Side</title>

    <!-- *** References for Mapillary and leaflet stylesheets ... -->
    <link href='https://unpkg.com/mapillary-js@2.5.0/dist/mapillary.min.css' rel='stylesheet' />
    <link href='https://unpkg.com/leaflet@1.0.1/dist/leaflet.css' rel='stylesheet' />

    <!-- *** References for Mapillary and Leaflet  ... -->
    <script src='https://unpkg.com/mapillary-js@2.5.0/dist/mapillary.min.js'></script>
    <script src='https://unpkg.com/leaflet@1.0.1/dist/leaflet.js'></script>

    <!-- *** References for MapBox GL JS and stylesheet ... -->
		<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />

    <!-- *** References for MapBox GL Draw plugin and stylesheet... -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.18.0/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.18.0/mapbox-gl-draw.css' type='text/css'/>

    <!-- *** Styles... -->
    <style>
      html, body {
        min-height: 100%;
        min-width: 100%;
        margin: 0;
        padding: 0;
      }
      table {
        width: 95vw;
        height: 95vh;
      }
      td {
        width: 50%;
        height: 50%;
      }
      #menu {
          background: #fff;
          position: absolute;
          z-index: 1;
          top: 10px;
          left: 60px;
          border-radius: 3px;
          width: 200px;
          border: 1px solid rgba(0,0,0,0.4);
          font-family: 'Open Sans', sans-serif;
      }

      #menu a {
          font-size: 13px;
          color: #404040;
          display: block;
          margin: 0;
          padding: 0;
          padding: 10px;
          text-decoration: none;
          border-bottom: 1px solid rgba(0,0,0,0.25);
          text-align: center;
      }

      #menu a:last-child {
          border: none;
      }

      #menu a:hover {
          background-color: #f8f8f8;
          color: #404040;
      }

      #menu a.active {
          background-color: #3887be;
          color: #ffffff;
      }

      #menu a.active:hover {
          background: #3074a4;
      }
   </style>
  </head>

  <body>
    <!-- *** The page structure: above the maps and stree views ... -->
    <div id="titlebar">
     <center>
      <table border=0 style="width:95vw;height:5vw">
        <tr>
         <td>
          <div id="address">
           <center>
              Search for:
              <input id="textToGeoCode" type="text" placeholder="Type city name or address or lat,long ..." size="30">
           </center>
          </div>
         </td>
        </tr>
      </table>
    </center>
    </div>

    <!-- *** The page structure: the maps and street views ... -->
    <div id="maps-images">
     <center>
      <table border=1>
       <!-- first row -->
       <tr id="row1">
         <td id="g_map">
           <div id="google_map" style="width:100%;height:100%"></div>
         </td>
         <td id="google-street-view">
           <div id="no_google-street-view_images" style="width:100%;height:100%;position:absolute;z-index:1;top:25%;left:60%;color:red;display:none">
             <p>
                <b>
                 There are no Google Street View images for the current location.<br>
                 Please, type another city, address or lat, long coordinates !!!
                </b>
             </p>
          </div>
           <div id="google-street-view_images" style="width:100%;height:100%"></div>
         </td>
       </tr>
       <!-- second row -->
  	   <tr id="row2">
         <td id="osm">
           <div id="osm_map" style="width:100%;height:100%">
             <nav id="menu"></nav>
           </div>
         </td>
         <td id="mapillary">
           <div id="no_mapillary_images" style="width:100%;height:100%;position:absolute;z-index:1;top:75%;left:60%;color:red;display:none">
             <p>
                <b>
                 There are no Mapillary images for the current location.<br>
                 Please, type another city, address or lat, long coordinates !!!
                </b>
             </p>
          </div>
          <div id="mapillary_images" style="width:100%;height:100%;position:relative"></div>
         </td>
       </tr>
      </table>
    </center>
    </div>

    <!-- *** The page structure: below the maps and street views ... -->
    <div id="bottom">
      Bottom ...
    </div>

    <!-- *** The script section ... -->
    <script>
      var google_map;                      //*** the Google Map ...
      var osm_map;                         //*** the OpenStreet Map ...
      var panorama;                        //*** the Google Street View ...
      var mly;                             //*** Mapillary ...
      var no_mapillary_images = false;     //*** to control if Mapillary images exist or not ...
      var no_streetview_images = false;    //*** to control if Google Street View images exist or not ...
      var listenerHandle;                  //*** the listener on Google Map for mousedown event ...
      var marker;                          //*** ???
      var theClickWasMadeOn = "Mapillary"; //*** Where the user clicked on  ...
      var editedPointLat = 0;
      var editedPointLng = 0;
      var latParam;
      var lngParam;


      function getUrlParameter(name) {
       name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
       var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
       var results = regex.exec(location.search);
       return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      };

      latParam = getUrlParameter('lat');
      //alert("Lat = " + latParam);

      lngParam = getUrlParameter('lng');
      //alert("Lng = " + lngParam);




      //*** Intercept the user click when happen on Google Street View div  ...
      var google_street_view_images_div = document.getElementById("google-street-view_images"); //grab the element
      google_street_view_images_div.onclick = function() {
       window.theClickWasMadeOn = "StreetView";
      }

      //*** Intercept the user click when happen on Mapillary div  ...
      var mapillary_images_div = document.getElementById("mapillary_images"); //grab the element
      mapillary_images_div.onclick = function() {
        window.theClickWasMadeOn = "Mapillary";
      }

      //*** Center OSM map and synchronize Google Street View and Mapillary  ...
      function synchro(view, lat, lng) {
       window.osm_map.setCenter([lng, lat]);

       if (view == "StreetView") {
         myLatLng = new google.maps.LatLng({lat: lat, lng: lng});

         //*** Update Google Street View  to the current position ...
         window.panorama.setPosition(myLatLng);
       }
       else {
         window.mly.moveCloseTo(lat, lng)
           .then(
             //*** If images are founded ...
            function(node) {
              //alert("Ok mly ...");
              var mapillary_images_div = document.getElementById('mapillary_images');
              mapillary_images_div.style.opacity = 1;
              var no_mapillary_images_div = document.getElementById('no_mapillary_images');
              no_mapillary_images_div.style.display = "none";

              no_mapillary_images = false;

              console.log(node.key); },
            //*** If images are NOT founded: in this case show a hidden div with messages ...
            function(error) {
             //alert("KO mly ...");
             var mapillary_images_div = document.getElementById('mapillary_images');
             mapillary_images_div.style.opacity = .2;
             var no_mapillary_images_div = document.getElementById('no_mapillary_images');
             no_mapillary_images_div.style.display = "";

             //*** Set that NO Mapillary images are founded ...
             no_mapillary_images = true;

             console.error(error);
            });
       }
      }

      //*** Define a listener on Google Map for mousedown event and change the cursor option ...
      function prepareAddMarker(e){
           listenerHandle = google.maps.event.addListener(window.google_map, 'mousedown', addMarker);
           window.google_map.setOptions({draggableCursor:'crosshair'});
       }

       //*** Add a marker on Google Map at user click ...
      function addMarker(e){
         //*** Remove previous marker if exist ...
         if (marker != null) marker.setMap(null);

         editedPointLat = e.latLng.lat();
         editedPointLng = e.latLng.lng();

         //*** Define icon ...
         var icon = {
              path: "M-20,0a20,20 0 1,0 40,0a20,20 0 1,0 -40,0",
              fillColor: '#FF0000',
              fillOpacity: .6,
              anchor: new google.maps.Point(0,0),
              strokeWeight: 0,
              scale: 0.5
          }

          //*** Create a new Google marker ...
          marker = new google.maps.Marker({
              //position: event.latLng,
              position: {lat: e.latLng.lat(), lng: e.latLng.lng()},
              map: window.google_map,
              draggable: false,
              icon: icon,
              zIndex : -20
          });

          //*** Set the map center at the user click coordinates ...
          window.google_map.setCenter(new google.maps.LatLng(e.latLng.lat(), e.latLng.lng()));

          //alert("Centrata la mappa Google a :" + e.latLng);

          //*** Remove the listener and set the cursor icon to the default ...
          google.maps.event.removeListener(listenerHandle);
          window.google_map.setOptions({draggableCursor:''});

          //*** Update the search text input with the user click coordinates ...
          updatePlace(e.latLng.lat(), e.latLng.lng());
       }

       //*** Remove marker on Google Map ...
      function removeMarker(e){
          marker.setMap(null);
      }

      //*** Update the search text input with the user click coordinates ...
      function updatePlace (lat, lng){
          //*** Get the search text input ...
          var input = document.getElementById("textToGeoCode");

          //*** Set the search text input with the user click coordinates ...
          var theText = input.value;
          input.value = lat + "," + lng;

          //*** Generate a click event on the search text input ...
          google.maps.event.trigger(input, 'focus')
          google.maps.event.trigger(input, 'keydown', { keyCode: 13 });
      }


      function initialize() {
        //var pegman_position = {lat: 42.628386111111126, lng: 13.291408333333237};  //*** The original pegman position ...
        var new_pegman_position;  //*** The original pegman position ...
        var marker;                                                                //*** ??? ...
        var startEdit = false;                                                     //*** ??? ...
        var currentPositionLat;                                                    //*** ??? ...
        var currentPositionLng;                                                    //*** ??? ...

        //alert("Lat = " + latParam);

        //pegman_position = {lat: latParam, lng: lngParam};

        new_pegman_position = new google.maps.LatLng(latParam, lngParam);

        //*** Create a div with a marker to put on OSM map ...
        var el = document.createElement('div');
        el.className = 'marker';
        el.style.backgroundImage = 'url(http://www.cesaregerbino.com/Mapillary/StreetImageCompare/markerTransparent.png)';
        el.style.width = '50px';
        el.style.height = '50px';

        //alert("paegman Lat = " + pegman_position.lat);

        //*** Add Google Map ...
        google_map = new google.maps.Map(document.getElementById('google_map'), {
          mapTypeControlOptions: {
              mapTypeIds: []
          },
          center: new_pegman_position,
          zoom: 16
        });

        //alert("aggiunta gmaps ... ");

        //*** Add a search text input ...
        var searchBox = new google.maps.places.SearchBox(document.getElementById("textToGeoCode"));

        //*** Add a listener on search text input ...
        google.maps.event.addListener(searchBox, 'places_changed', function() {
             var currentLat;
             var currentLng;

             searchBox.set('google_map', null);

             var places = searchBox.getPlaces();
             var bounds = new google.maps.LatLngBounds();

             var i, place;
             for (i = 0; place = places[i]; i++) {
               (function(place) {
                 bounds.extend(place.geometry.location);
               }(place));
             }

             window.google_map.fitBounds(bounds);
             searchBox.set('google_map', google_map);
             google_map.setZoom(Math.min(google_map.getZoom(),16));

             window.theClickWasMadeOn = "StreetView";

             if (editedPointLat == 0) {
                currentLat = bounds.getCenter().lat();
                currentLng = bounds.getCenter().lng();
             }
             else {
               currentLat = editedPointLat;
               currentLng = editedPointLng;
               editedPointLat = 0;
               editedPointLng = 0;
             }

             window.google_map.setCenter(new google.maps.LatLng(currentLat, currentLng));

             //google_map.setCenter(bounds.getCenter());

             //alert("Centrata mappa google..." + google_map.getCenter());

             //window.osm_map.setCenter([google_map.getCenter().lng(), google_map.getCenter().lat()]);
             window.osm_map.setCenter([currentLng, currentLat]);

             //alert("Centrata mappa osm...");

             //*** Synchronize Google Street View ...
             window.panorama.setPosition(google_map.getCenter());

             window.mly.moveCloseTo(google_map.getCenter().lat(), google_map.getCenter().lng())
               .then(
                    //*** If images are founded ...
                    function(node) {
                      var mapillary_images_div = document.getElementById('mapillary_images');
                      mapillary_images_div.style.opacity = 1;
                      var no_mapillary_images_div = document.getElementById('no_mapillary_images');
                      no_mapillary_images_div.style.display = "none";

                      no_mapillary_images = false;

                      console.log(node.key); },
                    //*** If images are NOT founded: in this case show a hidden div with messages ...
                    function(error) {
                     var mapillary_images_div = document.getElementById('mapillary_images');
                     mapillary_images_div.style.opacity = .2;
                     var no_mapillary_images_div = document.getElementById('no_mapillary_images');
                     no_mapillary_images_div.style.display = "";

                     //*** Set that NO Mapillary images are founded ...
                     no_mapillary_images = true;

                     console.error(error);
                    });

             var streetview = new google.maps.StreetViewService();

             //alert("Lat = " + window.google_map.getCenter().lat() + " - Lng = " + window.google_map.getCenter().lng());

             var streetViewLocation = new google.maps.LatLng(google_map.getCenter().lat(), google_map.getCenter().lng());

             //var streetViewLocation = new google.maps.LatLng(37.579578, 14.522108);

             streetview.getPanoramaByLocation(streetViewLocation, 50, function(data, status) {
                 if (status == 'OK') {
                     //google has a streetview image for this location, so attach it to the streetview div
                     //alert("OK, there are some Google Street Images .... ");

                     var google_street_view_images_div = document.getElementById('google-street-view_images');
                     google_street_view_images_div.style.opacity = 1;
                     var no_google_street_view_images_div = document.getElementById('no_google-street-view_images');
                     no_google_street_view_images_div.style.display = "none";

                     if (no_streetview_images == true) {
                        var new_pegman_position = {lat: currentPositionLat, lng: currentPositionLng};

                        window.panorama = new google.maps.StreetViewPanorama(
                          document.getElementById('google-street-view_images'), {
                            position: new_pegman_position,
                            pov: {
                              heading: 34,
                              pitch: 10
                            }
                          });
                       google_map.setStreetView(window.panorama);

                       window.panorama.addListener('position_changed', function(){
                         if (theClickWasMadeOn == "StreetView") {
                           currentPositionLat = window.panorama.getPosition().lat();
                           currentPositionLng = window.panorama.getPosition().lng();
                           window.synchro("Mapillary", currentPositionLat, currentPositionLng);
                           }
                        });

                       no_streetview_images = false;
                     }

                     //no_mapillary_images = false;

                }
                 else{
                     //no google streetview image for this location, so hide the streetview div
                     //alert("Ops !!! There are NO Google Street Images .... ");

                     var google_street_view_images_div = document.getElementById('google-street-view_images');
                     google_street_view_images_div.style.opacity = .2;
                     var no_google_street_view_images_div = document.getElementById('no_google-street-view_images');
                     no_google_street_view_images_div.style.display = "";

                     no_streetview_images = true;


                     //*** Set that NO Mapillary images are founded ...
                     //no_mapillary_images = true;

                 }
             });
           });

        //*** Add a button to draw point on Google Maps ...
        var controlEditUI = document.createElement('DIV');
        controlEditUI.id = "controlEditUI";
        controlEditUI.style.cursor = 'pointer';
        controlEditUI.style.backgroundImage = "url(http://www.cesaregerbino.com/Mapillary/StreetImageCompare/marker.png)";
        controlEditUI.style.height = '28px';
        controlEditUI.style.width = '25px';
        controlEditUI.style.top = '11px';
        controlEditUI.style.left = '120px';
        controlEditUI.style.marginLeft = '10px';
        controlEditUI.title = 'Click to get the coordinates';
        window.google_map.controls[google.maps.ControlPosition.LEFT_TOP].push(controlEditUI);

        //*** Add a listener on the button to draw point on Google Maps for the mousedown event ...
        controlEditUI.addEventListener('mousedown', prepareAddMarker);

        //### Add a button to cancel markers on Google Maps ...
        var controlTrashUI = document.createElement('DIV');
        controlTrashUI.id = 'controlTrashUI';
        controlTrashUI.style.cursor = 'pointer';
        controlTrashUI.style.backgroundImage = "url(http://www.cesaregerbino.com/Mapillary/StreetImageCompare/trash.png)";
        controlTrashUI.style.height = '28px';
        controlTrashUI.style.width = '25px';
        controlTrashUI.style.top = '11px';
        controlTrashUI.style.left = '150px';
        controlTrashUI.style.marginLeft = '10px';
        controlTrashUI.title = 'Click to remove marker from the map';
        window.google_map.controls[google.maps.ControlPosition.LEFT_TOP].push(controlTrashUI);

        //*** Add a listener on the button to cancel markers on Google Maps for the click event ...
        controlTrashUI.addEventListener('click', removeMarker);

        //alert("lat = " + new_pegman_position.lat());

        //*** Add Google Street View ...
        window.panorama = new google.maps.StreetViewPanorama(
          document.getElementById('google-street-view_images'), {
            position: new_pegman_position,
            pov: {
              heading: 34,
              pitch: 10
            }
          });
       google_map.setStreetView(window.panorama);

       //*** Add a listener on Google Street View on position_changed event ...
       window.panorama.addListener('position_changed', function(){
         if (theClickWasMadeOn == "StreetView") {
           currentPositionLat = window.panorama.getPosition().lat();
           currentPositionLng = window.panorama.getPosition().lng();
           window.synchro("Mapillary", currentPositionLat, currentPositionLng);
           }
        });

      //*** Add MapBox / OSM Map ...
      var center = new mapboxgl.LngLat(lngParam, latParam);
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2VzYXJlIiwiYSI6Im1LdmxtRU0ifQ.uoGK9BB9eywCPknCRlB9JA';
      osm_map = new mapboxgl.Map({
          container: 'osm_map',                               //*** container id
          style: 'mapbox://styles/mapbox/bright-v9',          //*** stylesheet location
          //center: [13.291408333333237,42.628386111111126],  //*** starting position
          center: center,                        //*** starting position
          zoom: 16                                            //*** starting zoom
      });

      //*** Add zoom and rotation controls to the MapBox / OMS map ...
      osm_map.addControl(new mapboxgl.NavigationControl());

      //*** Add the draw control to the MapBox / OMS map ...
      var draw = new MapboxDraw({
          displayControlsDefault: false,
          controls: {
              point: true,
              trash: true
          }
      });
      osm_map.addControl(draw, 'top-left');

      //*** Add the edit button to the MapBox / OMS map ...
      var editButton = document.getElementsByClassName('mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_point'); // grab a reference to your element

      //*** Set that the edit session started ...
      for(i=0; i<editButton.length; i++) {
          editButton[i].onclick = function(){
                    startEdit = true;
              };
      }

      //*** Manage the mouse down event on the MapBox / OMS map ...
      osm_map.on('mousedown', function (e) {
        // ** Get  geo points  ...
        geoCoords = e.lngLat;

        //*** Get the point geo coordinates  ...
        lng = Number(geoCoords.lng.toFixed(5));
        lat = Number(geoCoords.lat.toFixed(5));

        if (startEdit == true) {
          //*** Get the search text input ...
          var input = document.getElementById("textToGeoCode");

          //*** Set the search text input with the user click coordinates ...
          var theText = input.value;
          input.value = lat + "," + lng;

          //*** Set that the edit session finished ...
          startEdit = false;

          //*** Generate a click event on the search text input ...
          google.maps.event.trigger(input, 'focus')
          google.maps.event.trigger(input, 'keydown', { keyCode: 13 });
       };
      });

      // *** ON/OFF Mapillary sequences ...
      var toggleableLayerIds = [ 'ON/OFF Mapillary sequences' ];
      for (var i = 0; i < toggleableLayerIds.length; i++) {
          var id = toggleableLayerIds[i];

          var link = document.createElement('a');
          link.href = '#';
          link.className = 'active';
          link.textContent = id;

          link.onclick = function (e) {
              var clickedLayer = this.textContent;
              e.preventDefault();
              e.stopPropagation();

              var visibility = osm_map.getLayoutProperty(clickedLayer, 'visibility');

              if (visibility === 'visible') {
                  osm_map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                  this.className = '';
              } else {
                  this.className = 'active';
                  osm_map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
              }
          };

          var layers = document.getElementById('menu');
          layers.appendChild(link);
      }

      // *** The Mapillary sequences reference ...
      var mapillarySource = {
          type: 'vector',
          tiles: ['http://d25uarhxywzl1j.cloudfront.net/v0.1/{z}/{x}/{y}.mvt'],
          minzoom: 0,
          maxzoom: 16
      }

      // *** Load Mapillary sequences layer to the map ...
      osm_map.on('style.load', function () {
              osm_map.addSource('mapillarySequences', mapillarySource)
              osm_map.addLayer({
                  'id': 'ON/OFF Mapillary sequences',
                  'type': 'line',
                  'source': 'mapillarySequences',
                  'source-layer': 'mapillary-sequences',
                  'layout': {
                      'line-cap': 'round',
                      'line-join': 'round'
                  },
                  'paint': {
                      'line-opacity': 0.6,
                      'line-color':   'rgb(53, 175, 109)',
                      'line-width':   2
                  }
              }, 'markers')
      })

      //*** Add Mapillary ...
      window.mly = new Mapillary.Viewer(
              'mapillary_images',
              'QWJSSnU3YWRLRFlzc2Q2ZDJZMDc2dzplMjU5ZjIwN2QyMzliZDdh' /*,
              'Sx1k3lLpdFU1TWS-8u_Y-w',
          {
              component: {
                  cover: false
              }
          } */
        );

      //alert("mapillary lat = " + new_pegman_position.lat());

      window.mly.setCenter(new_pegman_position.lat(), new_pegman_position.lng());

      //alert("mapillary lon = " + new_pegman_position.lng());

      window.mly.moveCloseTo(new_pegman_position.lat(), new_pegman_position.lng())
            .then(
                function(node) { console.log(node.key); },
                function(error) { console.error(error); });

      //*** Put a marker on OSM map and to synchronize it with Mapillary images locations  ...
      window.mly.on(Mapillary.Viewer.nodechanged, function (node) {
          var latLon = { lat: node.latLon.lat, lng: node.latLon.lon };

          //alert("lat x center mly = " + latLon.lat);
          //alert("lng x center mly = " + latLon.lng);

          //*** Create a marker if does not exist and set the current position or, if the marker already exist, set it to the current position  ...
          if (!marker) {
              marker = new mapboxgl.Marker(el, {offset: [-30, -35]})
                .setLngLat([node.latLon.lon, node.latLon.lat])
                .addTo(osm_map);
          } else {
              marker.setLngLat([node.latLon.lon, node.latLon.lat]);
          };

          if (theClickWasMadeOn == "Mapillary") {
            currentPositionLat = node.latLon.lat;
            currentPositionLng = node.latLon.lon;
            window.synchro("StreetView", currentPositionLat, currentPositionLng);
          }
      });

      window.addEventListener('resize', function() { mly.resize(); });

      }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4w4Yw72Rf3z8Z7TnLQ6HkJqZ5NEgV2pw&libraries=places&callback=initialize">
    </script>

  </body>
</html>
