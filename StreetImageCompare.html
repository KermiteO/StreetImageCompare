<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Street Image Compare View Side-by-Side</title>

    <!-- *** References for Mapillary and leaflet stylesheets ... -->
    <link href='https://unpkg.com/mapillary-js@2.5.0/dist/mapillary.min.css' rel='stylesheet' />
    <link href='https://unpkg.com/leaflet@1.0.1/dist/leaflet.css' rel='stylesheet' />

    <!-- *** References for Mapillary and Leaflet  ... -->
    <script src='https://unpkg.com/mapillary-js@2.5.0/dist/mapillary.min.js'></script>
    <script src='https://unpkg.com/leaflet@1.0.1/dist/leaflet.js'></script>

    <!-- *** References for MapBox GL JS and stylesheet ... -->
		<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />

    <!-- *** References for MapBox GL Draw plugin and stylesheet... -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.18.0/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.18.0/mapbox-gl-draw.css' type='text/css'/>

    <!-- *** Styles... -->
    <style>
      html, body {
        min-height: 100%;
        min-width: 100%;
        margin: 0;
        padding: 0;
      }
      table {
        width: 95vw;
        height: 95vh;
      }
      td {
        width: 50%;
        height: 50%;
      }
      #menu {
          background: #fff;
          position: absolute;
          z-index: 1;
          top: 10px;
          left: 60px;
          border-radius: 3px;
          width: 200px;
          border: 1px solid rgba(0,0,0,0.4);
          font-family: 'Open Sans', sans-serif;
      }

      #menu a {
          font-size: 13px;
          color: #404040;
          display: block;
          margin: 0;
          padding: 0;
          padding: 10px;
          text-decoration: none;
          border-bottom: 1px solid rgba(0,0,0,0.25);
          text-align: center;
      }

      #menu a:last-child {
          border: none;
      }

      #menu a:hover {
          background-color: #f8f8f8;
          color: #404040;
      }

      #menu a.active {
          background-color: #3887be;
          color: #ffffff;
      }

      #menu a.active:hover {
          background: #3074a4;
      }
   </style>
  </head>

  <body>
    <!-- *** The page structure: above the maps and stree views ... -->
    <div id="titlebar">
     <center>
      <table border=0 style="width:95vw;height:5vw">
        <tr>
         <td>
          <div id="address">
           <center>
              Search for:
              <input id="textToGeoCode" type="text" placeholder="Type city name or address or lat,long ..." size="30">
           </center>
          </div>
         </td>
         <td>
          <div id="selectStreetView">
           <center>
            Choose the street image that will be the "master":
            <select onchange="onSelect.call(this, event)">
              <option value="mapillary">Google Street View</option>
              <option value="streetview">Mapillary</option>
            </select>
           </center>
          </div>
         </td>
        </tr>
      </table>
    </center>
    </div>

    <!-- *** The page structure: the maps and street views ... -->
    <div id="maps-images">
     <center>
      <table border=1>
       <!-- first row -->
       <tr id="row1">
         <td id="g_map">
           <div id="google_map" style="width:100%;height:100%"></div>
         </td>
         <td id="google-street-view">
           <div id="no_google-street-view_images" style="width:100%;height:100%;position:absolute;z-index:1;top:25%;left:60%;color:red;display:none">
             <p>
                <b>
                 There are no Google Street View images for the current location.<br>
                 Please, type another city, address or lat, long coordinates !!!
                </b>
             </p>
          </div>
           <div id="google-street-view_images" style="width:100%;height:100%"></div>
         </td>
       </tr>
       <!-- second row -->
  	   <tr id="row2">
         <td id="osm">
           <div id="osm_map" style="width:100%;height:100%">
             <nav id="menu"></nav>
           </div>
         </td>
         <td id="mapillary">
           <div id="no_mapillary_images" style="width:100%;height:100%;position:absolute;z-index:1;top:75%;left:60%;color:red;display:none">
             <p>
                <b>
                 There are no Mapillary images for the current location.<br>
                 Please, type another city, address or lat, long coordinates !!!
                </b>
             </p>
          </div>
          <div id="mapillary_images" style="width:100%;height:100%;position:relative"></div>
         </td>
       </tr>
      </table>
    </center>
    </div>

    <!-- *** The page structure: below the maps and street views ... -->
    <div id="bottom">
      Bottom ...
    </div>

    <!-- *** The script section ... -->
    <script>
      var google_map;                  //*** the Google Map ...
      var panorama;                    //*** the Google Street View ...
      var mly;                         //*** Mapillary ...
      var no_mapillary_images = false; //*** to control if Mapillary images exist or not ...
      var listenerHandle;              //*** the listener on Google Map for mousedown event ...
      var marker;                      //*** ???

      //*** Define a listener on Google Map for mousedown event and change the cursor option ...
      function prepareAddMarker(e){
           listenerHandle = google.maps.event.addListener(window.google_map, 'mousedown', addMarker);
           window.google_map.setOptions({draggableCursor:'crosshair'});
       }

       //*** Add a marker on Google Map at user click ...
      function addMarker(e){
         //*** Remove previous marker if exist ...
         if (marker != null) marker.setMap(null);

         //*** Define icon ...
         var icon = {
              path: "M-20,0a20,20 0 1,0 40,0a20,20 0 1,0 -40,0",
              fillColor: '#FF0000',
              fillOpacity: .6,
              anchor: new google.maps.Point(0,0),
              strokeWeight: 0,
              scale: 0.5
          }

          //*** Create a new Google marker ...
          marker = new google.maps.Marker({
              //position: event.latLng,
              position: {lat: e.latLng.lat(), lng: e.latLng.lng()},
              map: window.google_map,
              draggable: false,
              icon: icon,
              zIndex : -20
          });

          //*** Set the map center at the user click coordinates ...
          window.google_map.setCenter(new google.maps.LatLng(e.latLng.lat(), e.latLng.lng()));

          //*** Remove the listener and set the cursor icon to the default ...
          google.maps.event.removeListener(listenerHandle);
          window.google_map.setOptions({draggableCursor:''});

          //*** Update the search text input with the user click coordinates ...
          updatePlace(e.latLng.lat(), e.latLng.lng());
       }

       //*** Remove marker on Google Map ...
      function removeMarker(e){
          marker.setMap(null);
      }

      //*** Update the search text input with the user click coordinates ...
      function updatePlace (lat, lng){
          //*** Get the search text input ...
          var input = document.getElementById("textToGeoCode");

          //*** Set the search text input with the user click coordinates ...
          var theText = input.value;
          input.value = lat + "," + lng;

          //*** Generate a click event on the search text input ...
          google.maps.event.trigger(input, 'focus')
          google.maps.event.trigger(input, 'keydown', { keyCode: 13 });
      }


      function initialize() {
        var pegman_position = {lat: 42.628386111111126, lng: 13.291408333333237};  //*** The original pegman position ...
        var marker;                                                                //*** ??? ...
        var startEdit = false;                                                     //*** ??? ...

        //*** Create a div with a marker to put on OSM map ...
        var el = document.createElement('div');
        el.className = 'marker';
        el.style.backgroundImage = 'url(http://localhost/Mapillary/StreetImageCompare/markerTransparent.png)';
        el.style.width = '50px';
        el.style.height = '50px';

        //*** Add Google Map ...
        google_map = new google.maps.Map(document.getElementById('google_map'), {
          center: pegman_position,
          zoom: 16
        });

        //*** Add a search text input ...
        var searchBox = new google.maps.places.SearchBox(document.getElementById("textToGeoCode"));

        //*** Add a listener on search text input ...
        google.maps.event.addListener(searchBox, 'places_changed', function() {
             searchBox.set('google_map', null);

             var places = searchBox.getPlaces();
             var bounds = new google.maps.LatLngBounds();

             var i, place;
             for (i = 0; place = places[i]; i++) {
               (function(place) {
                 bounds.extend(place.geometry.location);
               }(place));
             }

             window.google_map.fitBounds(bounds);
             searchBox.set('google_map', google_map);
             google_map.setZoom(Math.min(google_map.getZoom(),16));

             //*** Syinchronize Google Street View ...
             window.panorama.setPosition(google_map.getCenter());




             var streetview = new google.maps.StreetViewService();

             //alert("Lat = " + window.google_map.getCenter().lat() + " - Lng = " + window.google_map.getCenter().lng());

             var streetViewLocation = new google.maps.LatLng(google_map.getCenter().lat(), google_map.getCenter().lng());

             //var streetViewLocation = new google.maps.LatLng(37.579578, 14.522108);

             streetview.getPanoramaByLocation(streetViewLocation, 50, function(data, status) {
                 if (status == 'OK') {
                     //google has a streetview image for this location, so attach it to the streetview div
                     //alert("OK, there are some Google Street Images .... ");

                     var google_street_view_images_div = document.getElementById('google-street-view_images');
                     google_street_view_images_div.style.opacity = 1;
                     var no_google_street_view_images_div = document.getElementById('no_google-street-view_images');
                     no_google_street_view_images_div.style.display = "none";

                     //no_mapillary_images = false;

                }
                 else{
                     //no google streetview image for this location, so hide the streetview div
                     //alert("Ops !!! There are NO Google Street Images .... ");

                     var google_street_view_images_div = document.getElementById('google-street-view_images');
                     google_street_view_images_div.style.opacity = .2;
                     var no_google_street_view_images_div = document.getElementById('no_google-street-view_images');
                     no_google_street_view_images_div.style.display = "";

                     //*** Set that NO Mapillary images are founded ...
                     //no_mapillary_images = true;

                 }
             });





           });

        //*** Add a button to draw point on Google Maps ...
        var controlEditUI = document.createElement('DIV');
        controlEditUI.id = "controlEditUI";
        controlEditUI.style.cursor = 'pointer';
        controlEditUI.style.backgroundImage = "url(http://localhost/Mapillary/StreetImageCompare/marker.png)";
        controlEditUI.style.height = '28px';
        controlEditUI.style.width = '25px';
        controlEditUI.style.top = '11px';
        controlEditUI.style.left = '120px';
        controlEditUI.style.marginLeft = '10px';
        controlEditUI.title = 'Click to get the coordinates';
        window.google_map.controls[google.maps.ControlPosition.LEFT_TOP].push(controlEditUI);

        //*** Add a listener on the button to draw point on Google Maps for the mousedown event ...
        controlEditUI.addEventListener('mousedown', prepareAddMarker);

        //### Add a button to cancel markers on Google Maps ...
        var controlTrashUI = document.createElement('DIV');
        controlTrashUI.id = 'controlTrashUI';
        controlTrashUI.style.cursor = 'pointer';
        controlTrashUI.style.backgroundImage = "url(http://localhost/Mapillary/StreetImageCompare/trash.png)";
        controlTrashUI.style.height = '28px';
        controlTrashUI.style.width = '25px';
        controlTrashUI.style.top = '11px';
        controlTrashUI.style.left = '150px';
        controlTrashUI.style.marginLeft = '10px';
        controlTrashUI.title = 'Click to remove marker from the map';
        window.google_map.controls[google.maps.ControlPosition.LEFT_TOP].push(controlTrashUI);

        //*** Add a listener on the button to cancel markers on Google Maps for the click event ...
        controlTrashUI.addEventListener('click', removeMarker);

        //*** Add Google Street View ...
        window.panorama = new google.maps.StreetViewPanorama(
          document.getElementById('google-street-view_images'), {
            position: pegman_position,
            pov: {
              heading: 34,
              pitch: 10
            }
          });
       google_map.setStreetView(window.panorama);

       //*** Add a listener on Google Street View on position_changed event ...
       window.panorama.addListener('position_changed', function(){
          //var latLon = { lat: window.panorama.getPosition().lat(), lng: window.panorama.getPosition().lng() };

          //*** Create a marker if does not exist and set the current position or, if the marker already exist, set it to the current position  ...
          if (!marker) {
              marker = new mapboxgl.Marker()
                .setLngLat([window.panorama.getPosition().lng(), window.panorama.getPosition().lat()])
                .addTo(osm_map);
          } else {
              marker.setLngLat([window.panorama.getPosition().lng(), window.panorama.getPosition().lat()]);
          }

          //*** Set OSM center to the current position ...
          osm_map.setCenter([window.panorama.getPosition().lng(), window.panorama.getPosition().lat()]);

          //*** Set Mapillary images to the current position ...
          window.mly.moveCloseTo(window.panorama.getPosition().lat(), window.panorama.getPosition().lng())
              .then(
                   //*** If images are founded ...
                  function(node) {
                    var mapillary_images_div = document.getElementById('mapillary_images');
                    mapillary_images_div.style.opacity = 1;
                    var no_mapillary_images_div = document.getElementById('no_mapillary_images');
                    no_mapillary_images_div.style.display = "none";

                    no_mapillary_images = false;

                    console.log(node.key); },
                  //*** If images are NOT founded: in this case show a hidden div with messages ...
                  function(error) {
                    var mapillary_images_div = document.getElementById('mapillary_images');
                    mapillary_images_div.style.opacity = .2;
                    var no_mapillary_images_div = document.getElementById('no_mapillary_images');
                    no_mapillary_images_div.style.display = "";

                    //*** Set that NO Mapillary images are founded ...
                    no_mapillary_images = true;

                    console.error(error);
                  });

      });

      //*** Add MapBox / OSM Map ...
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2VzYXJlIiwiYSI6Im1LdmxtRU0ifQ.uoGK9BB9eywCPknCRlB9JA';
      var osm_map = new mapboxgl.Map({
          container: 'osm_map',                            //*** container id
          style: 'mapbox://styles/mapbox/bright-v9',       //*** stylesheet location
          center: [13.291408333333237,42.628386111111126], //*** starting position
          zoom: 16                                         //*** starting zoom
      });

      //*** Add zoom and rotation controls to the MapBox / OMS map ...
      osm_map.addControl(new mapboxgl.NavigationControl());

      //*** Add the draw control to the MapBox / OMS map ...
      var draw = new MapboxDraw({
          displayControlsDefault: false,
          controls: {
              point: true,
              trash: true
          }
      });
      osm_map.addControl(draw, 'top-left');

      //*** Add the edit button to the MapBox / OMS map ...
      var editButton = document.getElementsByClassName('mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_point'); // grab a reference to your element

      //*** Set that the edit session started ...
      for(i=0; i<editButton.length; i++) {
          editButton[i].onclick = function(){
                    startEdit = true;
              };
      }

      //*** Manage the mouse down event on the MapBox / OMS map ...
      osm_map.on('mousedown', function (e) {
        // ** Get  geo points  ...
        geoCoords = e.lngLat;

        //*** Get the point geo coordinates  ...
        lng = Number(geoCoords.lng.toFixed(5));
        lat = Number(geoCoords.lat.toFixed(5));

        if (startEdit == true) {
          //*** Get the search text input ...
          var input = document.getElementById("textToGeoCode");

          //*** Set the search text input with the user click coordinates ...
          var theText = input.value;
          input.value = lat + "," + lng;

          //*** Set that the edit session finished ...
          startEdit = false;

          //*** Generate a click event on the search text input ...
          google.maps.event.trigger(input, 'focus')
          google.maps.event.trigger(input, 'keydown', { keyCode: 13 });
       };
      });

      // *** ON/OFF Mapillary sequences ...
      var toggleableLayerIds = [ 'ON/OFF Mapillary sequences' ];
      for (var i = 0; i < toggleableLayerIds.length; i++) {
          var id = toggleableLayerIds[i];

          var link = document.createElement('a');
          link.href = '#';
          link.className = 'active';
          link.textContent = id;

          link.onclick = function (e) {
              var clickedLayer = this.textContent;
              e.preventDefault();
              e.stopPropagation();

              var visibility = osm_map.getLayoutProperty(clickedLayer, 'visibility');

              if (visibility === 'visible') {
                  osm_map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                  this.className = '';
              } else {
                  this.className = 'active';
                  osm_map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
              }
          };

          var layers = document.getElementById('menu');
          layers.appendChild(link);
      }

      // *** The Mapillary sequences reference ...
      var mapillarySource = {
          type: 'vector',
          tiles: ['http://d25uarhxywzl1j.cloudfront.net/v0.1/{z}/{x}/{y}.mvt'],
          minzoom: 0,
          maxzoom: 16
      }

      // *** Load Mapillary sequences layer to the map ...
      osm_map.on('style.load', function () {
              osm_map.addSource('mapillarySequences', mapillarySource)
              osm_map.addLayer({
                  'id': 'ON/OFF Mapillary sequences',
                  'type': 'line',
                  'source': 'mapillarySequences',
                  'source-layer': 'mapillary-sequences',
                  'layout': {
                      'line-cap': 'round',
                      'line-join': 'round'
                  },
                  'paint': {
                      'line-opacity': 0.6,
                      'line-color':   'rgb(53, 175, 109)',
                      'line-width':   2
                  }
              }, 'markers')
      })

      //*** Add Mapillary ...
      window.mly = new Mapillary.Viewer(
              'mapillary_images',
              'QjI1NnU0aG5FZFZISE56U3R5aWN4ZzowODkzY2RjNjM1ZmEwYTVi',
              'Sx1k3lLpdFU1TWS-8u_Y-w',
          {
              component: {
                  cover: false
              }
          }
        );
      window.mly.deactivateComponent("direction");
      window.mly.deactivateComponent("sequence");

      window.mly.setCenter(pegman_position.lat, pegman_position.lon);

      //*** Draw a green line for the Google Street View table cell ...
      var td = document.getElementById("google-street-view");
      td.style.borderColor = "green";
      td.style.borderWidth = "5px";
      td.style.borderStyle = "solid";

      //*** Put a marker on OSM map and to synchronize it with Mapillary images locations  ...
      window.mly.on(Mapillary.Viewer.nodechanged, function (node) {
          var latLon = { lat: node.latLon.lat, lng: node.latLon.lon };

          //*** Create a marker if does not exist and set the current position or, if the marker already exist, set it to the current position  ...
          if (!marker) {
              marker = new mapboxgl.Marker(el, {offset: [-30, -35]})
                .setLngLat([node.latLon.lon, node.latLon.lat])
                .addTo(osm_map);
          } else {
              marker.setLngLat([node.latLon.lon, node.latLon.lat]);
          }

          //*** Set OSM center to the current position ...
          osm_map.setCenter([node.latLon.lon, node.latLon.lat]);

          //*** Get the new current position ...
          myLatLng = new google.maps.LatLng({lat: node.latLon.lat, lng: node.latLon.lon});

          //*** Update Google Street View  to the current position ...
          window.panorama.setPosition(myLatLng);
      });

      window.addEventListener('resize', function() { mly.resize(); });

      }


      //*** Fuction to manage the street view type ...
      function onSelect(event) {
          switch (this.options[this.selectedIndex].text) {
             case "Mapillary":
               if (no_mapillary_images == false) {
                 var td = document.getElementById("mapillary");
                 td.style.borderColor = "green";
                 td.style.borderWidth = "5px";
                 td.style.borderStyle = "solid";

                 var td = document.getElementById("google-street-view");
                 td.style.borderColor = "black";
                 td.style.borderWidth = "1px";
                 td.style.borderStyle = "solid";

                 window.mly.activateComponent("direction");
                 window.mly.activateComponent("sequence");

                 var panoOptions = {
                   scrollwheel: false,
                   disableDefaultUI: true,
                   clickToGo: false
                 };
                 window.panorama.setOptions(panoOptions);
               }
             break;
             case "Google Street View":
               var td = document.getElementById("google-street-view");
               td.style.borderColor = "green";
               td.style.borderWidth = "5px";
               td.style.borderStyle = "solid";

               var td = document.getElementById("mapillary");
               td.style.borderColor = "black";
               td.style.borderWidth = "1px";
               td.style.borderStyle = "solid";

               window.mly.deactivateComponent("direction");
               window.mly.deactivateComponent("sequence");

               var panoOptions = {
                 scrollwheel: true,
                 disableDefaultUI: false,
                 clickToGo: true
               };
               window.panorama.setOptions(panoOptions);
               break;
            }
      }

    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4w4Yw72Rf3z8Z7TnLQ6HkJqZ5NEgV2pw&libraries=places&callback=initialize">
    </script>

  </body>
</html>
